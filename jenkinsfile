pipeline {

    agent any

    tools {
        nodejs 'nodejs-18'
    }

    environment {

        SONARQUBE_SERVER = 'sonar'

        NEXUS_URL       = 'http://18.189.28.205:8081'
        NEXUS_REPO      = 'raw-releases'
        NEXUS_ARTIFACT  = 'online-book-store'

        NGINX_WEB_ROOT  = '/var/www/html'
        NGINX_SERVER_IP = '18.223.44.159'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        skipDefaultCheckout(true)
    }

    stages {

        stage('Checkout Code') {
            steps {
                echo "üì¶ Fetching repository..."

                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/uday79936/Online-book-store.git'
                    ]]
                ])

                echo "‚úî Checkout complete"
            }
        }

        stage('Install Dependencies') {
            steps {
                echo 'üì• Installing dependencies...'

                sh '''
                    npm config set fund false
                    npm ci || npm install
                '''

                echo "‚úî Dependencies installed"
            }
        }

        stage('Unit Tests + Coverage') {
            steps {
                echo 'üß™ Running tests...'

                sh '''
                    npm test -- --passWithNoTests --coverage
                '''

                echo "‚úî Tests completed"
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {

                    def sonarSources = sh(
                        script: '[ -d "src" ] && echo src || echo .',
                        returnStdout: true
                    ).trim()

                    echo "üìÇ Sonar sources: ${sonarSources}"

                    withSonarQubeEnv("${SONARQUBE_SERVER}") {

                        sh """
                            if [ ! -f "coverage/lcov.info" ]; then
                                mkdir -p coverage
                                echo "" > coverage/lcov.info
                            fi

                            npx sonar-scanner \
                            -Dsonar.projectKey=online-book-store \
                            -Dsonar.projectName="online-book-store" \
                            -Dsonar.projectVersion="0.0.${BUILD_NUMBER}" \
                            -Dsonar.sources="${sonarSources}" \
                            -Dsonar.javascript.lcov.reportPaths="coverage/lcov.info" \
                            -Dsonar.sourceEncoding="UTF-8"
                        """
                    }
                }
            }
        }

        stage('Build Artifact') {
            steps {
                echo '‚öôÔ∏è Building production app...'

                sh 'npm run build'

                sh '''
                    if [ ! -d build ]; then
                        echo "‚ùå build folder missing!"
                        exit 1
                    fi
                '''

                echo "‚úî Build ready"
            }
        }

        stage('Package Artifact') {
            steps {
                echo "üì¶ Creating deployment package..."

                sh '''
                    VERSION="0.0.${BUILD_NUMBER}"
                    TARBALL="${NEXUS_ARTIFACT}-${VERSION}.tar.gz"

                    tar -czf "${TARBALL}" -C build .

                    echo "‚úî Created artifact: ${TARBALL}"
                '''
            }
        }

        stage('Upload Artifact to Nexus') {
            steps {

                withCredentials([
                    usernamePassword(
                        credentialsId: 'nexus',
                        usernameVariable: 'NEXUS_USR',
                        passwordVariable: 'NEXUS_PSW'
                    )
                ]) {

                    echo "üì§ Uploading tarball to Nexus..."

                    sh '''
                        VERSION="0.0.${BUILD_NUMBER}"
                        TARBALL="${NEXUS_ARTIFACT}-${VERSION}.tar.gz"
                        FILE_PATH="${TARBALL}"

                        UPLOAD_URL="${NEXUS_URL}/repository/${NEXUS_REPO}/${TARBALL}"

                        curl -f -u "${NEXUS_USR}:${NEXUS_PSW}" \
                        --upload-file "${FILE_PATH}" "${UPLOAD_URL}"
                    '''

                    echo "‚úî Artifact uploaded!"
                }
            }
        }

        stage('Deploy to Nginx') {
            steps {

                withCredentials([
                    usernamePassword(
                        credentialsId: 'nexus',
                        usernameVariable: 'NEXUS_USR',
                        passwordVariable: 'NEXUS_PSW'
                    ),
                    sshUserPrivateKey(
                        credentialsId: 'nginx-ssh',
                        keyFileVariable: 'SSH_KEY'
                    )
                ]) {

                    echo "‚¨áÔ∏è Download artifact to Jenkins..."

                    sh '''
                        VERSION="0.0.${BUILD_NUMBER}"
                        TARBALL="${NEXUS_ARTIFACT}-${VERSION}.tar.gz"
                        DOWNLOAD_URL="${NEXUS_URL}/repository/${NEXUS_REPO}/${TARBALL}"

                        curl -f -u "${NEXUS_USR}:${NEXUS_PSW}" \
                        -o "/tmp/${TARBALL}" "${DOWNLOAD_URL}"
                    '''

                    echo "üì§ Transfer artifact to nginx server..."

                    sh '''
                        VERSION="0.0.${BUILD_NUMBER}"
                        TARBALL="${NEXUS_ARTIFACT}-${VERSION}.tar.gz"

                        scp -o StrictHostKeyChecking=no -i $SSH_KEY \
                        /tmp/${TARBALL} \
                        ubuntu@${NGINX_SERVER_IP}:/tmp/${TARBALL}
                    '''

                    echo "üöÄ Deploying on nginx..."

                    sh '''
                        VERSION="0.0.${BUILD_NUMBER}"
                        TARBALL="${NEXUS_ARTIFACT}-${VERSION}.tar.gz"
                        WEB_ROOT="${NGINX_WEB_ROOT}"

                        ssh -o StrictHostKeyChecking=no -i $SSH_KEY ubuntu@${NGINX_SERVER_IP} \
                        "sudo rm -rf ${WEB_ROOT:?}/* && \
                         sudo mkdir -p ${WEB_ROOT} && \
                         sudo tar -xzf /tmp/${TARBALL} -C ${WEB_ROOT} && \
                         sudo rm -f /tmp/${TARBALL} && \
                         sudo chmod -R 755 ${WEB_ROOT} && \
                         sudo systemctl restart nginx"
                    '''

                    echo "‚úî Deployment completed!"
                }
            }
        }
    }

    post {
        success {
            echo 'üéâ Pipeline completed successfully!'
        }
        failure {
            echo '‚ùå Pipeline failed ‚Äî review errors!'
        }
    }
}
